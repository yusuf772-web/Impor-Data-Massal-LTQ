<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impor Data Massal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        .card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        .btn-primary:disabled {
            background-color: #374151;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #6b7280;
        }
        .file-input-label {
            border: 2px dashed #4b5563;
            text-align: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            /* Added for vertical alignment */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }
        .file-input-label:hover {
            border-color: #3b82f6;
            background-color: #273142;
        }
        .file-input-label.has-file {
            border-color: #22c55e;
            background-color: #163326;
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i data-lucide="upload-cloud" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Impor Data Massal</h1>
            </div>
            <a href="admin.html" class="btn btn-secondary">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Kembali ke Panel Admin
            </a>
        </header>

        <!-- Import Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Impor Pembimbing -->
            <div class="card flex flex-col">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white">Impor Pembimbing</h2>
                        <p class="text-gray-400 text-sm mt-1">Header: `name`</p>
                    </div>
                    <a href="data:text/csv;charset=utf-8,name%0AUstadz Fulan" download="template_pembimbing.csv" class="btn btn-secondary !px-3 !py-2 text-xs flex-shrink-0">
                        <i data-lucide="download" class="w-4 h-4 mr-1"></i>Template
                    </a>
                </div>
                <form id="importMentorForm" class="flex flex-col flex-grow space-y-4">
                    <label for="mentorFile" class="file-input-label">
                        <i data-lucide="file-up" class="w-8 h-8 mx-auto text-gray-500"></i>
                        <span id="mentorFileName" class="mt-2 block text-sm">Klik atau seret file CSV</span>
                    </label>
                    <input type="file" id="mentorFile" class="hidden" accept=".csv">
                    <button type="submit" class="btn btn-primary w-full mt-auto">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>Impor Pembimbing
                    </button>
                </form>
            </div>

            <!-- Impor Kelas -->
            <div class="card flex flex-col">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white">Impor Kelas</h2>
                        <p class="text-gray-400 text-sm mt-1">Header: `name`</p>
                    </div>
                    <a href="data:text/csv;charset=utf-8,name%0A1A" download="template_kelas.csv" class="btn btn-secondary !px-3 !py-2 text-xs flex-shrink-0">
                        <i data-lucide="download" class="w-4 h-4 mr-1"></i>Template
                    </a>
                </div>
                <form id="importClassForm" class="flex flex-col flex-grow space-y-4">
                     <label for="classFile" class="file-input-label">
                        <i data-lucide="file-up" class="w-8 h-8 mx-auto text-gray-500"></i>
                        <span id="className" class="mt-2 block text-sm">Klik atau seret file CSV</span>
                    </label>
                    <input type="file" id="classFile" class="hidden" accept=".csv">
                    <button type="submit" class="btn btn-primary w-full mt-auto">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>Impor Kelas
                    </button>
                </form>
            </div>

            <!-- Impor Santri -->
            <div class="card flex flex-col">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-semibold text-white">Impor Santri</h2>
                        <p class="text-gray-400 text-sm mt-1">Header: `name`, `class`</p>
                    </div>
                    <a href="data:text/csv;charset=utf-8,name,class%0AAhmad,1A" download="template_santri.csv" class="btn btn-secondary !px-3 !py-2 text-xs flex-shrink-0">
                        <i data-lucide="download" class="w-4 h-4 mr-1"></i>Template
                    </a>
                </div>
                <form id="importStudentForm" class="flex flex-col flex-grow space-y-4">
                     <label for="studentFile" class="file-input-label">
                        <i data-lucide="file-up" class="w-8 h-8 mx-auto text-gray-500"></i>
                        <span id="studentFileName" class="mt-2 block text-sm">Klik atau seret file CSV</span>
                    </label>
                    <input type="file" id="studentFile" class="hidden" accept=".csv">
                    <button type="submit" class="btn btn-primary w-full mt-auto">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>Impor Santri
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Toast Message -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBzvOsp5EVnzTI8Kbew9nXSXXLpakBD6Ec",
            authDomain: "ltq-hn.firebaseapp.com",
            projectId: "ltq-hn",
            storageBucket: "ltq-hn.appspot.com",
            messagingSenderId: "542731528480",
            appId: "1:542731528480:web:15203f68716ed2e3dacf45"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Global State ---
        let currentUserId = null;

        // --- DOM Elements ---
        const dom = {
            importMentorForm: document.getElementById('importMentorForm'),
            mentorFile: document.getElementById('mentorFile'),
            mentorFileName: document.getElementById('mentorFileName'),
            importClassForm: document.getElementById('importClassForm'),
            classFile: document.getElementById('classFile'),
            className: document.getElementById('className'),
            importStudentForm: document.getElementById('importStudentForm'),
            studentFile: document.getElementById('studentFile'),
            studentFileName: document.getElementById('studentFileName'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage'),
        };

        // --- UI Logic ---
        const showToast = (message, isError = false) => {
            dom.toastMessage.textContent = message;
            dom.toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            setTimeout(() => {
                dom.toast.className = dom.toast.className.replace('translate-y-0 opacity-100', 'translate-y-20 opacity-0');
            }, 5000);
        };
        
        const setupFileInput = (inputEl, labelEl, textEl) => {
            inputEl.addEventListener('change', () => {
                if (inputEl.files.length > 0) {
                    textEl.textContent = inputEl.files[0].name;
                    labelEl.classList.add('has-file');
                } else {
                    textEl.textContent = 'Klik atau seret file CSV';
                    labelEl.classList.remove('has-file');
                }
            });
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                try {
                    await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
                } catch (error) {
                    console.error("Authentication error:", error);
                    showToast("Error autentikasi: " + error.message, true);
                }
            }
        });

        // --- Import Logic ---
        const handleImport = async (e, fileInput, collectionName, expectedHeaders) => {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            
            if (!currentUserId) {
                showToast("Autentikasi diperlukan. Silakan muat ulang halaman.", true);
                return;
            }
            if (fileInput.files.length === 0) {
                showToast("Silakan pilih file CSV terlebih dahulu.", true);
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i> Memproses...`;
            lucide.createIcons();

            const file = fileInput.files[0];
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const headers = results.meta.fields;
                    const isValid = expectedHeaders.every(h => headers.includes(h));

                    if (!isValid) {
                        showToast(`Format CSV salah. Pastikan header adalah: ${expectedHeaders.join(', ')}`, true);
                        submitButton.disabled = false;
                        submitButton.innerHTML = `<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Impor`;
                        lucide.createIcons();
                        return;
                    }

                    const dataToImport = results.data;
                    let successCount = 0;
                    let errorCount = 0;

                    for (const item of dataToImport) {
                        try {
                            // Ensure no empty rows are processed
                            if (Object.values(item).every(x => x === null || x === '')) continue;
                            
                            const docData = { ...item, timestamp: serverTimestamp(), addedBy: currentUserId };
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), docData);
                            successCount++;
                        } catch (err) {
                            console.error("Error adding document:", err, item);
                            errorCount++;
                        }
                    }

                    showToast(`Impor selesai. Berhasil: ${successCount}, Gagal: ${errorCount}.`, errorCount > 0);
                    e.target.reset();
                    fileInput.dispatchEvent(new Event('change')); // To reset file name in label
                    submitButton.disabled = false;
                    const originalText = e.target.querySelector('button[type="submit"]').textContent;
                    submitButton.innerHTML = `<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Impor ${collectionName.charAt(0).toUpperCase() + collectionName.slice(1, -1)}`;
                    lucide.createIcons();
                },
                error: (error) => {
                    showToast(`Gagal mem-parsing file CSV: ${error.message}`, true);
                    submitButton.disabled = false;
                     const originalText = e.target.querySelector('button[type="submit"]').textContent;
                    submitButton.innerHTML = `<i data-lucide="upload" class="w-4 h-4 mr-2"></i>Impor ${collectionName.charAt(0).toUpperCase() + collectionName.slice(1, -1)}`;
                    lucide.createIcons();
                }
            });
        };

        // --- Event Listeners ---
        dom.importMentorForm.addEventListener('submit', (e) => handleImport(e, dom.mentorFile, 'mentors', ['name']));
        dom.importClassForm.addEventListener('submit', (e) => handleImport(e, dom.classFile, 'classes', ['name']));
        dom.importStudentForm.addEventListener('submit', (e) => handleImport(e, dom.studentFile, 'students', ['name', 'class']));
        
        // --- Initial Setup ---
        lucide.createIcons();
        setupFileInput(dom.mentorFile, dom.mentorFile.previousElementSibling, dom.mentorFileName);
        setupFileInput(dom.classFile, dom.classFile.previousElementSibling, dom.className);
        setupFileInput(dom.studentFile, dom.studentFile.previousElementSibling, dom.studentFileName);
    </script>
</body>
</html>
